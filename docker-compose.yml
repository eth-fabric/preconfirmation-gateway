x-bin-base: &bin-base
  restart: unless-stopped
  environment:
    - RUST_LOG=${RUST_LOG:-info}

services:
  gateway:
    <<: *bin-base
    image: preconfirmation-gateway/gateway:${VERSION:-dev}
    container_name: gateway
    environment:
      - CB_CONFIG=/cb-config.toml
      - CB_MODULE_ID=${GATEWAY_MODULE_ID:-gateway-module}
      - CB_SIGNER_JWT=${GATEWAY_JWT}
      - CB_SIGNER_URL=${CB_SIGNER_URL:-http://localhost:20000}
      - GATEWAY_DEFAULT_BLS_KEY=${GATEWAY_DEFAULT_BLS_KEY}
    volumes:
      - ./config/gateway.config.toml:/cb-config.toml:ro
    ports:
      - "127.0.0.1:18080:8080"

  relay:
    <<: *bin-base
    image: preconfirmation-gateway/relay:${VERSION:-dev}
    container_name: relay
    environment:
      - RELAY_JWT=${RELAY_JWT}
    volumes:
      - ./config/relay.config.toml:/cb-config.toml:ro
    command: ["/cb-config.toml"]
    ports:
      - "127.0.0.1:8080:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

  proposer:
    <<: *bin-base
    image: preconfirmation-gateway/proposer:${VERSION:-dev}
    container_name: proposer
    environment:
      - CB_CONFIG=/cb-config.toml
      - CB_MODULE_ID=${PROPOSER_MODULE_ID:-proposer-module}
      - CB_SIGNER_JWT=${PROPOSER_JWT}
      - CB_SIGNER_URL=${CB_SIGNER_URL:-http://localhost:20000}
      - PROPOSER_METRICS_ADDR=0.0.0.0:9902
      - PROPOSER_DEFAULT_BLS_KEY=${PROPOSER_DEFAULT_BLS_KEY}
    volumes:
      - ./config/proposer.config.toml:/cb-config.toml:ro
    ports:
      - "127.0.0.1:9902:9902"

  spammer:
    <<: *bin-base
    image: preconfirmation-gateway/spammer:${VERSION:-dev}
    container_name: spammer
    volumes:
      - ./config/spammer.config.toml:/app/spammer-config.toml:ro

  signer:
    <<: *bin-base
    image: preconfirmation-gateway/signer:${VERSION:-dev}
    container_name: signer
    environment:
      - CB_CONFIG=/cb-config.toml
      - CB_JWTS=${CB_JWTS}
      - CB_SIGNER_ADMIN_JWT=${CB_SIGNER_ADMIN_JWT}
    volumes:
      - ./config/signer.config.toml:/cb-config.toml:ro
      - ./tests/data/keystores/keys:/app/tests/data/keystores/keys:ro
      - ./tests/data/keystores/secrets:/app/tests/data/keystores/secrets:ro
      - ./tests/data/proxy:/app/tests/data/proxy
    ports:
      - "127.0.0.1:20000:20000"

  beacon-mock:
    <<: *bin-base
    image: preconfirmation-gateway/beacon-mock:${VERSION:-dev}
    container_name: beacon-mock
    environment:
      - BEACON_API_URL=${BEACON_API_URL:-http://0.0.0.0:5052}
      - PROPOSER_BLS_KEY=${PROPOSER_DEFAULT_BLS_KEY}
    command: ["--url", "${BEACON_API_URL:-http://0.0.0.0:5052}", "${PROPOSER_DEFAULT_BLS_KEY}"]
    ports:
      - "127.0.0.1:5052:5052"

