use cb_common::utils::random_jwt_secret;
use indexmap::IndexMap;

// Generate .simulation.env file with all required environment variables
// for running the signer and other modules locally

fn main() -> eyre::Result<()> {
	let modules = vec!["gateway-module", "proposer-module", "relay-module"];
	let config_path = "config/signer.config.toml".to_string();

	let mut jwts = IndexMap::new();

	// Generate JWTs for each module
	modules.iter().for_each(|module| {
		jwts.insert(*module, random_jwt_secret());
	});

	// Create comma-separated JWT string for CB_JWTS
	let formatted_jwts = jwts.iter().map(|(k, v)| format!("{k}={v}")).collect::<Vec<_>>().join(",");

	// Generate admin JWT
	let admin_jwt = random_jwt_secret();

	// Build the .env file content
	let mut env_content = String::new();
	env_content.push_str("# Simulation environment variables\n");
	env_content.push_str("# Generated by simulation-setup binary\n");
	env_content.push_str("# Source with: set -a; source .simulation.env; set +a\n\n");

	env_content.push_str("# Signer configuration\n");
	env_content.push_str(&format!("CB_CONFIG={}\n", config_path));
	env_content.push_str(&format!("CB_JWTS={}\n", formatted_jwts));
	env_content.push_str(&format!("CB_SIGNER_ADMIN_JWT={}\n\n", admin_jwt));

	env_content.push_str("# Individual module JWTs\n");
	env_content.push_str(&format!("GATEWAY_JWT={}\n", jwts["gateway-module"]));
	env_content.push_str(&format!("PROPOSER_JWT={}\n", jwts["proposer-module"]));
	env_content.push_str(&format!("RELAY_JWT={}\n\n", jwts["relay-module"]));

	env_content.push_str("# Service configuration\n");
	env_content.push_str("CB_SIGNER_URL=http://localhost:20000\n\n");

	env_content.push_str("# Module IDs\n");
	env_content.push_str("GATEWAY_MODULE_ID=gateway-module\n");
	env_content.push_str("PROPOSER_MODULE_ID=proposer-module\n");
	env_content.push_str("RELAY_MODULE_ID=relay-module\n");

	// Write to .simulation.env
	let env_path = std::path::Path::new(".simulation.env");
	std::fs::write(&env_path, env_content)?;
	println!("\nâœ“ Simulation environment file written to: {env_path:?}");
	println!("  Use 'set -a; source .simulation.env; set +a' to load variables");

	Ok(())
}
